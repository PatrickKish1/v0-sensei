// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import {Test} from "forge-std/Test.sol";
import {SenseiRegistry} from "../src/SenseiRegistry.sol";
import {SenseiToken} from "../src/SenseiToken.sol";
import {LessonNFT} from "../src/LessonNFT.sol";
import {BookingSystem} from "../src/BookingSystem.sol";
import {SensayAI} from "../src/SensayAI.sol";
import "../src/libraries/DataTypes.sol";

contract SenseiTest is Test {
    SenseiRegistry public senseiRegistry;
    SenseiToken public senseiToken;
    LessonNFT public lessonNFT;
    BookingSystem public bookingSystem;
    SensayAI public sensayAI;
    
    address public deployer;
    address public sensei1;
    address public sensei2;
    address public student1;
    address public student2;
    
    uint256 public sensei1Id;
    uint256 public sensei2Id;
    
    function setUp() public {
        deployer = address(this);
        sensei1 = makeAddr("sensei1");
        sensei2 = makeAddr("sensei2");
        student1 = makeAddr("student1");
        student2 = makeAddr("student2");
        
        // Deploy contracts
        senseiRegistry = new SenseiRegistry();
        senseiToken = new SenseiToken();
        lessonNFT = new LessonNFT(address(senseiToken));
        bookingSystem = new BookingSystem();
        sensayAI = new SensayAI(address(senseiRegistry));
        
        // Set up permissions
        senseiToken.setAuthorizedMinter(address(bookingSystem), true);
        lessonNFT.setAuthorizedMinter(address(bookingSystem), true);
        senseiRegistry.setAIAgentContract(address(sensayAI));
        
        // Fund addresses
        vm.deal(sensei1, 100 ether);
        vm.deal(sensei2, 100 ether);
        vm.deal(student1, 100 ether);
        vm.deal(student2, 100 ether);
    }
    
    // ============ SenseiRegistry Tests ============
    
    function testRegisterSensei() public {
        vm.startPrank(sensei1);
        
        uint256 senseiId = senseiRegistry.registerSensei(
            "Master Yoda",
            "Jedi Training",
            "Wise Jedi Master with centuries of experience",
            100 ether
        );
        
        assertEq(senseiId, 1);
        assertTrue(senseiRegistry.isRegisteredSensei(sensei1));
        
        SenseiRegistry.SenseiProfile memory profile = senseiRegistry.getSenseiProfile(senseiId);
        assertEq(profile.name, "Master Yoda");
        assertEq(profile.expertise, "Jedi Training");
        assertEq(profile.hourlyRate, 100 ether);
        assertTrue(profile.isActive);
        
        vm.stopPrank();
    }
    
    function testUpdateSenseiProfile() public {
        // First register
        vm.prank(sensei1);
        uint256 senseiId = senseiRegistry.registerSensei(
            "Master Yoda",
            "Jedi Training",
            "Wise Jedi Master",
            100 ether
        );
        
        // Then update
        vm.prank(sensei1);
        senseiRegistry.updateProfile(
            senseiId,
            "Master Yoda Updated",
            "Advanced Jedi Training",
            "Updated description",
            150 ether
        );
        
        SenseiRegistry.SenseiProfile memory profile = senseiRegistry.getSenseiProfile(senseiId);
        assertEq(profile.name, "Master Yoda Updated");
        assertEq(profile.expertise, "Advanced Jedi Training");
        assertEq(profile.hourlyRate, 150 ether);
    }
    
    // ============ SenseiToken Tests ============
    
    function testInitialTokenSupply() public {
        // Token should start with 0 supply
        assertEq(senseiToken.totalSupply(), 0);
        assertEq(senseiToken.balanceOf(deployer), 0);
    }
    
    function testMintWithETH() public {
        vm.deal(student1, 10 ether);
        
        vm.prank(student1);
        uint256 tokensMinted = senseiToken.mintWithETH{value: 1 ether}();
        
        // Should mint tokens based on current rate (starts at MIN_MINT_RATE = 100)
        assertEq(tokensMinted, 100 * 10**18); // 100 tokens per ETH
        assertEq(senseiToken.balanceOf(student1), 100 * 10**18);
        assertEq(senseiToken.totalSupply(), 100 * 10**18);
    }
    
    function testCompleteKnowledgeSession() public {
        // First mint some tokens to create backing
        vm.deal(student1, 10 ether);
        vm.prank(student1);
        senseiToken.mintWithETH{value: 1 ether}();
        
        // Then complete a knowledge session
        vm.prank(address(knowledgeSession));
        senseiToken.completeKnowledgeSession(1, 1000 ether, 500 ether);
        
        (uint256 knowledgeValue, uint256 backingValue) = senseiToken.getSessionInfo(1);
        assertEq(knowledgeValue, 1000 ether);
        assertEq(backingValue, 500 ether);
    }
    
    function testDynamicMintRate() public {
        // Start with minimum rate
        assertEq(senseiToken.getCurrentMintRate(), 100);
        
        // Complete a knowledge session to increase demand
        vm.prank(address(knowledgeSession));
        senseiToken.completeKnowledgeSession(1, 2000 ether, 1000 ether);
        
        // Force a rebase
        vm.warp(block.timestamp + 1 days);
        vm.prank(address(knowledgeSession));
        senseiToken.completeKnowledgeSession(2, 1000 ether, 500 ether);
        
        // Rate should increase due to high demand
        uint256 newRate = senseiToken.getCurrentMintRate();
        assertTrue(newRate > 100);
    }
    
    // ============ LessonNFT Tests ============
    
    function testCreateLessonNFT() public {
        vm.prank(address(knowledgeSession));
        uint256[] memory tokenIds = lessonNFT.createLessonNFT(
            1,
            sensei1,
            student1,
            "Jedi Training",
            "Basic Lightsaber Combat",
            "Learn the fundamentals of lightsaber combat",
            60,
            100 ether,
            1000 ether,
            8 // Lesson quality 8/10
        );
        
        assertEq(tokenIds.length, 2);
        assertEq(tokenIds[0], 1); // Student NFT
        assertEq(tokenIds[1], 2); // Public NFT
        
        // Check student NFT
        LessonNFT.LessonMetadata memory studentMetadata = lessonNFT.getLessonMetadata(tokenIds[0]);
        assertEq(studentMetadata.isStudentNFT, true);
        assertEq(studentMetadata.isMinted, true);
        assertEq(lessonNFT.ownerOf(tokenIds[0]), student1);
        assertEq(studentMetadata.lessonQuality, 8);
        
        // Check public NFT
        LessonNFT.LessonMetadata memory publicMetadata = lessonNFT.getLessonMetadata(tokenIds[1]);
        assertEq(publicMetadata.isStudentNFT, false);
        assertEq(publicMetadata.isMinted, false);
        assertEq(lessonNFT.ownerOf(tokenIds[1]), sensei1);
        assertEq(publicMetadata.lessonQuality, 8);
        
        // Check that mint price was calculated based on quality
        assertTrue(publicMetadata.mintPrice > 0);
    }
    
    function testMintPublicLessonNFT() public {
        // First create the NFTs
        vm.prank(address(knowledgeSession));
        uint256[] memory tokenIds = lessonNFT.createLessonNFT(
            1,
            sensei1,
            student1,
            "Jedi Training",
            "Basic Lightsaber Combat",
            "Learn the fundamentals of lightsaber combat",
            60,
            100 ether,
            1000 ether,
            9 // High quality lesson
        );
        
        // Mint some tokens for student2 to pay for NFT
        vm.deal(student2, 10 ether);
        vm.prank(student2);
        uint256 tokensMinted = senseiToken.mintWithETH{value: 1 ether}();
        
        // Then mint the public NFT
        vm.prank(student2);
        lessonNFT.mintLessonNFT(tokenIds[1]);
        
        LessonNFT.LessonMetadata memory metadata = lessonNFT.getLessonMetadata(tokenIds[1]);
        assertTrue(metadata.isMinted);
        assertEq(lessonNFT.ownerOf(tokenIds[1]), student2);
    }
    
    // ============ KnowledgeSession Tests ============
    
    function testBookSession() public {
        // First register a sensei
        vm.prank(sensei1);
        uint256 senseiId = senseiRegistry.registerSensei(
            "Master Yoda",
            "Jedi Training",
            "Wise Jedi Master",
            100 ether
        );
        
        // Then book a session
        vm.prank(student1);
        uint256 sessionId = knowledgeSession.bookSession{value: 100 ether}(
            senseiId,
            "Jedi Training",
            "Basic Lightsaber Combat",
            "Learn the fundamentals of lightsaber combat",
            60,
            100 ether
        );
        
        assertEq(sessionId, 1);
        
        KnowledgeSession.Session memory session = knowledgeSession.getSession(sessionId);
        assertEq(session.senseiId, senseiId);
        assertEq(session.studentAddress, student1);
        assertEq(session.price, 100 ether);
        assertEq(uint256(session.state), uint256(KnowledgeSession.SessionState.PENDING));
    }
    
    function testCompleteSessionFlow() public {
        // 1. Register sensei
        vm.prank(sensei1);
        uint256 senseiId = senseiRegistry.registerSensei(
            "Master Yoda",
            "Jedi Training",
            "Wise Jedi Master",
            100 ether
        );
        
        // 2. Book session
        vm.prank(student1);
        uint256 sessionId = knowledgeSession.bookSession{value: 100 ether}(
            senseiId,
            "Jedi Training",
            "Basic Lightsaber Combat",
            "Learn the fundamentals of lightsaber combat",
            60,
            100 ether
        );
        
        // 3. Accept session
        vm.prank(sensei1);
        knowledgeSession.acceptSession(sessionId);
        
        // 4. Start session
        vm.prank(sensei1);
        knowledgeSession.startSession(sessionId);
        
        // 5. Complete session with quality rating
        vm.prank(sensei1);
        knowledgeSession.completeSession(sessionId, 1000 ether, 9); // High quality lesson
        
        KnowledgeSession.Session memory session = knowledgeSession.getSession(sessionId);
        assertEq(uint256(session.state), uint256(KnowledgeSession.SessionState.COMPLETED));
        assertTrue(session.isPaid);
        assertEq(session.knowledgeValue, 1000 ether);
        assertEq(session.lessonQuality, 9);
    }
    
    // ============ SensayAI Tests ============
    
    function testCreatePersonalAI() public {
        vm.prank(deployer);
        sensayAI.createPersonalAI(
            1,
            "Master Yoda",
            "Jedi Training",
            "Wise Jedi Master with centuries of experience"
        );
        
        DataTypes.PersonalAI memory personalAI = sensayAI.getPersonalAI(1);
        assertEq(personalAI.senseiId, 1);
        assertTrue(personalAI.isActive);
        assertEq(personalAI.aiModel, "GPT-4");
        assertTrue(bytes(personalAI.personalizedPrompt).length > 0);
    }
    
    function testInteractWithSensayAI() public {
        // First create personal AI
        vm.prank(deployer);
        sensayAI.createPersonalAI(
            1,
            "Master Yoda",
            "Jedi Training",
            "Wise Jedi Master"
        );
        
        // Then interact
        string memory response = sensayAI.interactWithSensayAI(1, "How do I use the Force?");
        
        assertTrue(bytes(response).length > 0);
        
        DataTypes.PersonalAI memory personalAI = sensayAI.getPersonalAI(1);
        assertEq(personalAI.interactionCount, 1);
    }
    
    // ============ Integration Tests ============
    
    function testFullSenseiWorkflow() public {
        // 1. Register sensei
        vm.prank(sensei1);
        uint256 senseiId = senseiRegistry.registerSensei(
            "Master Yoda",
            "Jedi Training",
            "Wise Jedi Master",
            100 ether
        );
        
        // 2. Create personal AI
        vm.prank(deployer);
        sensayAI.createPersonalAI(senseiId, "Master Yoda", "Jedi Training", "Wise Jedi Master");
        
        // 3. Book and complete session
        vm.prank(student1);
        uint256 sessionId = knowledgeSession.bookSession{value: 100 ether}(
            senseiId,
            "Jedi Training",
            "Basic Lightsaber Combat",
            "Learn the fundamentals of lightsaber combat",
            60,
            100 ether
        );
        
        vm.prank(sensei1);
        knowledgeSession.acceptSession(sessionId);
        
        vm.prank(sensei1);
        knowledgeSession.startSession(sessionId);
        
        vm.prank(sensei1);
        knowledgeSession.completeSession(sessionId, 1000 ether, 9); // High quality lesson
        
        // 4. Verify NFTs were created
        uint256[] memory tokenIds = lessonNFT.getTokenIdsForSession(sessionId);
        assertEq(tokenIds.length, 2);
        
        // 5. Verify student got their NFT
        assertEq(lessonNFT.ownerOf(tokenIds[0]), student1);
        
        // 6. Verify public NFT can be minted with SenseiTokens
        vm.prank(student2);
        vm.deal(student2, 10 ether);
        uint256 tokensMinted = senseiToken.mintWithETH{value: 1 ether}();
        
        vm.prank(student2);
        lessonNFT.mintLessonNFT(tokenIds[1]);
        assertEq(lessonNFT.ownerOf(tokenIds[1]), student2);
    }
    
    // ============ Error Tests ============
    
    function testCannotBookSessionWithInactiveSensei() public {
        // Register sensei
        vm.prank(sensei1);
        uint256 senseiId = senseiRegistry.registerSensei(
            "Master Yoda",
            "Jedi Training",
            "Wise Jedi Master",
            100 ether
        );
        
        // Deactivate sensei
        vm.prank(sensei1);
        senseiRegistry.deactivateSensei(senseiId);
        
        // Try to book session
        vm.prank(student1);
        vm.expectRevert("Sensei is not active");
        knowledgeSession.bookSession{value: 100 ether}(
            senseiId,
            "Jedi Training",
            "Basic Lightsaber Combat",
            "Learn the fundamentals of lightsaber combat",
            60,
            100 ether
        );
    }
    
    function testCannotMintStudentNFT() public {
        // Create NFTs
        vm.prank(address(knowledgeSession));
        uint256[] memory tokenIds = lessonNFT.createLessonNFT(
            1,
            sensei1,
            student1,
            "Jedi Training",
            "Basic Lightsaber Combat",
            "Learn the fundamentals of lightsaber combat",
            60,
            100 ether,
            1000 ether,
            8
        );
        
        // Try to mint student NFT (should fail)
        vm.prank(student2);
        vm.expectRevert("Cannot mint student NFT");
        lessonNFT.mintLessonNFT(tokenIds[0]);
    }
    
    function testTokenMintingWithDemand() public {
        // Start with no tokens
        assertEq(senseiToken.totalSupply(), 0);
        
        // Mint some tokens with ETH
        vm.deal(student1, 10 ether);
        vm.prank(student1);
        uint256 initialTokens = senseiToken.mintWithETH{value: 1 ether}();
        assertEq(initialTokens, 100 * 10**18);
        
        // Complete knowledge session to increase demand
        vm.prank(address(knowledgeSession));
        senseiToken.completeKnowledgeSession(1, 2000 ether, 1000 ether);
        
        // Force rebase
        vm.warp(block.timestamp + 1 days);
        
        // Mint more tokens - should get higher rate due to increased demand
        vm.prank(student2);
        vm.deal(student2, 10 ether);
        uint256 newTokens = senseiToken.mintWithETH{value: 1 ether}();
        
        // Should get more tokens due to higher demand
        assertTrue(newTokens >= initialTokens);
    }
    
    function testLessonQualityAffectsNFTPrice() public {
        // Create NFTs with different quality levels
        vm.prank(address(knowledgeSession));
        uint256[] memory lowQualityTokens = lessonNFT.createLessonNFT(
            1,
            sensei1,
            student1,
            "Jedi Training",
            "Basic Training",
            "Basic lesson",
            60,
            100 ether,
            500 ether,
            3 // Low quality
        );
        
        vm.prank(address(knowledgeSession));
        uint256[] memory highQualityTokens = lessonNFT.createLessonNFT(
            2,
            sensei1,
            student1,
            "Jedi Training",
            "Advanced Training",
            "Advanced lesson",
            60,
            100 ether,
            1500 ether,
            9 // High quality
        );
        
        // Get mint prices
        LessonNFT.LessonMetadata memory lowQualityMetadata = lessonNFT.getLessonMetadata(lowQualityTokens[1]);
        LessonNFT.LessonMetadata memory highQualityMetadata = lessonNFT.getLessonMetadata(highQualityTokens[1]);
        
        // Higher quality should have higher price
        assertTrue(highQualityMetadata.mintPrice > lowQualityMetadata.mintPrice);
    }
}
